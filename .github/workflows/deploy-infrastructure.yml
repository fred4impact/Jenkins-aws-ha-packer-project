name: Deploy Infrastructure Pipeline

on:
  workflow_dispatch:
    inputs:
      ami_id:
        description: 'AMI ID or Name (e.g., ami-0abc123def456789 or jenkins-ha-20240101120000)'
        required: true
        type: string
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - 'dev'
          - 'staging'
          - 'prod'
      aws_region:
        description: 'AWS Region'
        required: true
        default: 'us-east-1'
        type: choice
        options:
          - 'us-east-1'
          - 'us-west-2'
          - 'eu-west-1'

env:
  TERRAFORM_VERSION: 1.6.0

jobs:
  # ============================================
  # STAGE IV: DEPLOY INFRASTRUCTURE WITH TERRAFORM
  # ============================================
  deploy_infrastructure:
    name: Stage IV - Deploy Infrastructure with Terraform
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
    outputs:
      alb_dns: ${{ steps.terraform-output.outputs.alb_dns }}
      efs_id: ${{ steps.terraform-output.outputs.efs_id }}
      ami_id: ${{ steps.resolve-ami.outputs.ami_id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve AMI ID
        id: resolve-ami
        env:
          AMI_INPUT: ${{ github.event.inputs.ami_id }}
          AWS_REGION: ${{ github.event.inputs.aws_region || 'us-east-1' }}
        run: |
          echo "=== Resolving AMI ID ==="
          AMI_INPUT="${{ github.event.inputs.ami_id }}"
          AWS_REGION="${{ github.event.inputs.aws_region || 'us-east-1' }}"
          
          # Check if input is already an AMI ID (starts with ami-)
          if [[ "${AMI_INPUT}" =~ ^ami- ]]; then
            AMI_ID="${AMI_INPUT}"
            echo "‚úÖ Using provided AMI ID: ${AMI_ID}"
          else
            # Assume it's an AMI name, search for it
            echo "üîç Searching for AMI by name: ${AMI_INPUT}"
            
            # Configure AWS credentials for AMI lookup
            aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws configure set region ${AWS_REGION}
            
            # Search for AMI by name
            AMI_ID=$(aws ec2 describe-images \
              --owners self \
              --filters "Name=name,Values=${AMI_INPUT}" "Name=state,Values=available" \
              --query 'Images | sort_by(@, &CreationDate) | [-1].ImageId' \
              --output text \
              --region ${AWS_REGION} 2>/dev/null || echo "")
            
            if [ -z "${AMI_ID}" ] || [ "${AMI_ID}" == "None" ]; then
              echo "‚ùå Error: AMI not found with name '${AMI_INPUT}' in region ${AWS_REGION}"
              echo "Please provide a valid AMI ID (starting with ami-) or AMI name"
              exit 1
            fi
            
            echo "‚úÖ Found AMI ID: ${AMI_ID} for name: ${AMI_INPUT}"
          fi
          
          # Verify AMI exists and is available
          echo "üîç Verifying AMI exists and is available..."
          AMI_STATE=$(aws ec2 describe-images \
            --image-ids ${AMI_ID} \
            --region ${AWS_REGION} \
            --query 'Images[0].State' \
            --output text 2>/dev/null || echo "invalid")
          
          if [ "${AMI_STATE}" != "available" ]; then
            echo "‚ùå Error: AMI ${AMI_ID} is not available (state: ${AMI_STATE})"
            exit 1
          fi
          
          echo "ami_id=${AMI_ID}" >> $GITHUB_OUTPUT
          echo "‚úÖ AMI ID resolved: ${AMI_ID}"
          echo "‚úÖ AMI State: ${AMI_STATE}"
          
          # Display AMI details
          aws ec2 describe-images \
            --image-ids ${AMI_ID} \
            --region ${AWS_REGION} \
            --query 'Images[0].[ImageId,Name,State,CreationDate]' \
            --output table

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.aws_region || 'us-east-1' }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: ./terraform/main
        run: |
          echo "=== Initializing Terraform ==="
          terraform init

      - name: Terraform Validate
        working-directory: ./terraform/main
        run: |
          echo "=== Validating Terraform Configuration ==="
          terraform validate

      - name: Terraform Plan
        working-directory: ./terraform/main
        env:
          TF_VAR_jenkins_ami_id: ${{ steps.resolve-ami.outputs.ami_id }}
          TF_VAR_aws_region: ${{ github.event.inputs.aws_region || 'us-east-1' }}
          TF_VAR_environment: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          echo "=== Creating Terraform Plan ==="
          echo "AMI ID: ${{ steps.resolve-ami.outputs.ami_id }}"
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "AWS Region: ${{ github.event.inputs.aws_region || 'us-east-1' }}"
          
          terraform plan \
            -var="jenkins_ami_id=${{ steps.resolve-ami.outputs.ami_id }}" \
            -var="aws_region=${{ github.event.inputs.aws_region || 'us-east-1' }}" \
            -var="environment=${{ github.event.inputs.environment || 'dev' }}" \
            -out=tfplan
          
          echo "‚úÖ Terraform plan created successfully"

      - name: Terraform Apply
        working-directory: ./terraform/main
        env:
          TF_VAR_jenkins_ami_id: ${{ steps.resolve-ami.outputs.ami_id }}
          TF_VAR_aws_region: ${{ github.event.inputs.aws_region || 'us-east-1' }}
          TF_VAR_environment: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          echo "=== Deploying Infrastructure ==="
          echo "Creating:"
          echo "  - VPC, Subnets, IGW, NAT Gateways"
          echo "  - EFS File System"
          echo "  - Application Load Balancer"
          echo "  - Auto Scaling Group"
          echo "  - Launch Template (using Golden AMI: ${{ steps.resolve-ami.outputs.ami_id }})"
          
          terraform apply -auto-approve tfplan
          echo "‚úÖ Infrastructure deployed successfully"

      - name: Get Terraform outputs
        id: terraform-output
        working-directory: ./terraform/main
        run: |
          echo "=== Extracting Terraform Outputs ==="
          ALB_DNS=$(terraform output -raw alb_dns_name 2>/dev/null || echo "")
          EFS_ID=$(terraform output -raw efs_id 2>/dev/null || echo "")
          echo "alb_dns=${ALB_DNS}" >> $GITHUB_OUTPUT
          echo "efs_id=${EFS_ID}" >> $GITHUB_OUTPUT
          echo "‚úÖ ALB DNS: ${ALB_DNS}"
          echo "‚úÖ EFS ID: ${EFS_ID}"

      - name: Upload Terraform state (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: terraform/main/*.tfstate
          retention-days: 90
        continue-on-error: true

  # ============================================
  # STAGE V: POST-DEPLOYMENT CONFIGURATION
  # ============================================
  post_deployment:
    name: Stage V - Post-Deployment Configuration
    runs-on: ubuntu-latest
    needs: [deploy_infrastructure]
    if: needs.deploy_infrastructure.result == 'success'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.aws_region || 'us-east-1' }}

      - name: Wait for instances to be ready
        run: |
          echo "=== Waiting for Jenkins instances to be ready ==="
          ALB_DNS="${{ needs.deploy_infrastructure.outputs.alb_dns }}"
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          if [ -z "${ALB_DNS}" ]; then
            echo "‚ö†Ô∏è ALB DNS not available, skipping health check"
            exit 0
          fi
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -f -s "http://${ALB_DNS}/login" > /dev/null 2>&1; then
              echo "‚úÖ Jenkins is ready!"
              break
            fi
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt ${ATTEMPT}/${MAX_ATTEMPTS}: Waiting for Jenkins..."
            sleep 10
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "‚ö†Ô∏è Jenkins did not become ready in time"
            echo "This may be normal if instances are still starting up"
          fi

      - name: Run post-deployment scripts
        run: |
          echo "=== Running Post-Deployment Scripts ==="
          if [ -d "scripts" ]; then
            echo "‚úÖ Post-deployment scripts directory found"
            # Add your post-deployment script execution here
            # Example: ./scripts/post-deployment.sh
          else
            echo "‚ö†Ô∏è No post-deployment scripts found"
          fi

      - name: Verify deployment
        run: |
          echo "=== Verifying Deployment ==="
          ALB_DNS="${{ needs.deploy_infrastructure.outputs.alb_dns }}"
          EFS_ID="${{ needs.deploy_infrastructure.outputs.efs_id }}"
          AMI_ID="${{ needs.deploy_infrastructure.outputs.ami_id }}"
          
          echo "‚úÖ AMI ID: ${AMI_ID}"
          echo "‚úÖ ALB DNS: ${ALB_DNS}"
          echo "‚úÖ EFS ID: ${EFS_ID}"
          echo ""
          echo "=== Deployment Summary ==="
          echo "Infrastructure deployed successfully!"
          if [ -n "${ALB_DNS}" ]; then
            echo "üåê Jenkins URL: http://${ALB_DNS}"
          fi
          echo ""
          echo "üîó View in AWS Console:"
          echo "   Region: ${{ github.event.inputs.aws_region || 'us-east-1' }}"
          echo "   Environment: ${{ github.event.inputs.environment || 'dev' }}"

  # ============================================
  # NOTIFICATION JOB
  # ============================================
  notify:
    name: Deployment Summary and Notification
    runs-on: ubuntu-latest
    needs: [deploy_infrastructure, post_deployment]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "=== Deployment Pipeline Summary ==="
          echo "GitHub Run ID: ${{ github.run_id }}"
          echo "GitHub SHA: ${{ github.sha }}"
          echo "GitHub Ref: ${{ github.ref }}"
          echo ""
          echo "Input Parameters:"
          echo "  AMI ID/Name: ${{ github.event.inputs.ami_id }}"
          echo "  Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "  AWS Region: ${{ github.event.inputs.aws_region || 'us-east-1' }}"
          echo ""
          
          if [ "${{ needs.deploy_infrastructure.result }}" == "success" ]; then
            echo "‚úÖ Infrastructure deployed successfully"
            echo "‚úÖ AMI ID: ${{ needs.deploy_infrastructure.outputs.ami_id }}"
            if [ -n "${{ needs.deploy_infrastructure.outputs.alb_dns }}" ]; then
              echo "üåê Jenkins URL: http://${{ needs.deploy_infrastructure.outputs.alb_dns }}"
            fi
          else
            echo "‚ùå Deployment failed"
          fi
          
          echo ""
          echo "üìä Pipeline: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

